<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ShowcasingOz TV — Filming Locations Map</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin: 0; padding: 0; }
  .hero { padding: 18px; background: linear-gradient(180deg,#0f172a,#0b1220); color: white; }
  #map { height: 58vh; min-height: 420px; }
  .container { padding: 18px; max-width: 1100px; margin: 0 auto; }
  table { width: 100%; border-collapse: collapse; margin-top: 12px; }
  th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
  th { background: #f4f4f4; }
  .controls { display:flex; gap:12px; align-items:center; margin-top:12px; }
  .note { font-size:0.9rem; color:#444; }
  input[type=file] { padding:6px; }
  .btn { background:#0b74de; color:white; padding:8px 12px; border-radius:6px; border:none; cursor:pointer }
  .btn:disabled { opacity:0.6 }
  .popup-content { max-width: 260px; }
</style>
</head>
<body>
  <div class="hero">
    <h1>ShowcasingOz TV — Filming Locations</h1>
    <p>Load your itinerary (Excel or CSV) and the map will geocode each town and create markers with attraction details.</p>
  </div>

  <div id="map"></div>

  <div class="container">
    <div class="controls">
      <label class="note">Upload your itinerary Excel (.xlsx/.xls) or CSV (columns: Date, Town/City, Attraction):</label>
      <input id="file-input" type="file" accept=".xlsx,.xls,.csv" />
      <button id="clear-btn" class="btn">Clear Map</button>
    </div>
    <p class="note">The uploader will try to detect columns named like: <em>Date, DATE, Town, CITY/TOWN, City, Attraction, Itinerary</em>. If your file uses different headers, the page falls back to columns B, C and F (where available).</p>

    <h2>Itinerary Listing</h2>
    <p id="status" class="note">No file loaded.</p>
    <table id="itinerary-table" aria-describedby="status">
      <thead>
        <tr><th>Date</th><th>Town</th><th>Attractions / Filming Highlights</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- SheetJS (xlsx) for client-side Excel parsing -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
// Initialize map centered on Australia
const map = L.map('map').setView([-25.0, 134.0], 4);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 18, attribution: '&copy; OpenStreetMap contributors'}).addTo(map);

const fileInput = document.getElementById('file-input');
const tableBody = document.querySelector('#itinerary-table tbody');
const statusEl = document.getElementById('status');
const clearBtn = document.getElementById('clear-btn');
let markersLayer = L.layerGroup().addTo(map);

fileInput.addEventListener('change', async (ev) => {
  const f = ev.target.files[0];
  if (!f) return;
  statusEl.textContent = 'Reading file — please wait...';

  try {
    const data = await f.arrayBuffer();
    let rows = [];
    if (f.name.toLowerCase().endsWith('.csv')) {
      const txt = new TextDecoder().decode(data);
      rows = csvToRows(txt);
    } else {
      const wb = XLSX.read(data, {type: 'array'});
      const firstSheetName = wb.SheetNames[0];
      const sheet = wb.Sheets[firstSheetName];
      rows = XLSX.utils.sheet_to_json(sheet, {header:1, raw:false});
    }

    const parsed = parseRows(rows);
    if (parsed.length === 0) {
      statusEl.textContent = 'No usable rows found. Check your file headers or content.';
      return;
    }

    // Clear previous
    markersLayer.clearLayers();
    tableBody.innerHTML = '';

    statusEl.textContent = `Geocoding ${parsed.length} town(s). This may take a few seconds.`;

    let pending = parsed.length;
    for (const r of parsed) {
      appendRowToTable(r);
      geocodeTown(r.TOWN).then(coords => {
        if (coords) {
          const marker = L.marker([coords.lat, coords.lon]).addTo(markersLayer);
          const popupHtml = `<div class="popup-content"><strong>${escapeHtml(r.TOWN)}</strong><br/><em>${escapeHtml(r.DATE)}</em><p>${escapeHtml(r.ATTRACTION)}</p></div>`;
          marker.bindPopup(popupHtml);
        } else {
          const marker = L.marker([-25.0, 134.0]).addTo(markersLayer);
          marker.bindPopup(`<strong>${escapeHtml(r.TOWN)}</strong><br/><em>Geocoding not found</em>`);
        }
      }).catch(e => {
        const marker = L.marker([-25.0, 134.0]).addTo(markersLayer);
        marker.bindPopup(`<strong>${escapeHtml(r.TOWN)}</strong><br/><em>Error</em><p>${escapeHtml(String(e))}</p>`);
      }).finally(() => {
        pending -= 1;
        statusEl.textContent = pending > 0 ? `Geocoding... (${pending} remaining)` : 'All towns processed.';
      });
    }

  } catch (err) {
    statusEl.textContent = 'Error reading file: ' + String(err);
  }
});

clearBtn.addEventListener('click', () => {
  markersLayer.clearLayers();
  tableBody.innerHTML = '';
  statusEl.textContent = 'Cleared. No file loaded.';
  fileInput.value = '';
});

function csvToRows(txt) {
  const lines = txt.split(/\r?\n/).filter(Boolean);
  return lines.map(l => l.split(/,|\t/));
}

function parseRows(rows) {
  // If first row looks like headers identify columns
  if (rows.length === 0) return [];
  const header = rows[0].map(h => String(h||'').trim().toLowerCase());
  let dateIdx = header.findIndex(h=>['date','day','day no','dayno'].includes(h));
  let townIdx = header.findIndex(h=>['town','city','city/town','city/town '].includes(h));
  let attrIdx = header.findIndex(h=>['attraction','itinerary','attraction/itinerary','notes','attractions'].includes(h));

  // If headers not found, fallback to B,C,F -> indexes 1,2,5
  if (dateIdx === -1) dateIdx = 1;
  if (townIdx === -1) townIdx = 2;
  if (attrIdx === -1) attrIdx = 5;

  const out = [];
  for (let i = 1; i < rows.length; i++) {
    const r = rows[i];
    const date = r[dateIdx] || '';
    const town = r[townIdx] || '';
    const attraction = r[attrIdx] || '';
    if (String(date).trim() === '' && String(town).trim() === '' && String(attraction).trim() === '') continue;
    out.push({DATE: String(date).trim(), TOWN: String(town).trim(), ATTRACTION: String(attraction).trim()});
  }
  return out;
}

async function geocodeTown(town) {
  if (!town || town.trim() === '') return null;
  const q = encodeURIComponent(town + ', Australia');
  const url = `https://nominatim.openstreetmap.org/search?q=${q}&format=json&limit=1`;
  try {
    const resp = await fetch(url, { headers: { 'Accept-Language': 'en' }});
    const data = await resp.json();
    if (data && data.length > 0) return {lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon)};
    return null;
  } catch (e) {
    return null;
  }
}

function appendRowToTable(r) {
  const tr = document.createElement('tr');
  tr.innerHTML = `<td>${escapeHtml(r.DATE)}</td><td>${escapeHtml(r.TOWN)}</td><td>${escapeHtml(r.ATTRACTION)}</td>`;
  tableBody.appendChild(tr);
}

function escapeHtml(s) { if (!s) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }
</script>
</body>
</html>
