<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ShowcasingOz TV Filming Map</title>

  <!-- Font Awesome for social icons -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer" />

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    body { font-family: "Segoe UI", Roboto, Arial, sans-serif; margin: 0; color: #0E3557; background: #fff; }
    header.navbar { background: #0E3557; color: #fff; padding: 15px 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
    header.navbar .container { display: flex; justify-content: space-between; align-items: center; max-width: 1100px; margin: 0 auto; padding: 0 20px; }
    header.navbar img { height: 50px; width: auto; }
    nav a { color: #fff; margin-left: 20px; text-decoration: none; font-weight: 500; }
    nav a:hover { color: #E87722; transition: color 0.3s ease; }
    .menu-btn { display: none; font-size: 1.5rem; cursor: pointer; }
    @media (max-width: 768px) { nav { display: none; flex-direction: column; background: #0E3557; position: absolute; top: 70px; right: 0; width: 100%; } nav.active { display: flex; } .menu-btn { display: block; } nav a { padding: 15px; border-top: 1px solid rgba(255,255,255,0.1); } }
    .banner { display: block; width: 100%; height: 260px; background: url('banner.png') center top / contain no-repeat; background-color: #ffffff; border: none; margin-bottom: 20px; }
    .hero { padding: 18px; background: linear-gradient(180deg,#0f172a,#0b1220); color: white; text-align:center; }
    #map { height: 60vh; min-height: 480px; }
    .container { padding: 18px; max-width: 1100px; margin: 0 auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background: #f4f4f4; }
    .note { font-size:0.95rem; color:#444; }
    .popup-content { max-width: 320px; }
    .controls { display:flex; flex-wrap:wrap; gap:12px; align-items:center; margin-top:12px; justify-content:flex-end; }
    .btn { background:#0b74de; color:white; padding:8px 12px; border-radius:6px; border:none; cursor:pointer }
    .small { padding:6px 8px; font-size:0.95rem; }
    footer { background: #0E3557; color: #fff; padding: 30px 20px; font-size: 0.9rem; margin-top: 50px; }
    footer .footer-links { margin-bottom: 15px; }
    footer a { color: #E87722; text-decoration: none; margin: 0 10px; }
    footer a:hover { text-decoration: underline; }
    @media (max-width: 900px) { .container { padding: 12px; } }
  </style>
</head>
<body>

  <!-- HEADER / NAVBAR (copied exactly from your index.html) -->
  <header class="navbar">
    <div class="container">
      <a href="index.html">
        <img src="logo.png" alt="ShowcasingOz TV Logo">
      </a>
      <span class="menu-btn" id="menu-btn"><i class="fa fa-bars"></i></span>
      <nav id="menu">
        <a href="index.html">Home</a>
        <a href="about.html">About Us</a>
        <a href="partner.html">Partner With Us</a>
        <a href="sponsorship.html">Sponsorship</a>
        <a href="contact.html">Contact</a>
        <a href="filmingmap.html">Filming Map</a>
      </nav>
    </div>
  </header>

  <script>
    // Mobile menu toggle (same as index)
    const menuBtn = document.getElementById('menu-btn');
    const menu = document.getElementById('menu');
    if (menuBtn) menuBtn.addEventListener('click', () => menu.classList.toggle('active'));
  </script>

  <!-- Banner -->
  <section class="banner"></section>

  <div class="hero">
    <h1>ShowcasingOz TV Filming Map</h1>
    <p>Interactive map showing each town we will visit (one marker per town). Click pins for dates and attractions. Route line connects towns in visit order.</p>
  </div>

  <div id="map"></div>

  <div class="container">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
      <div class="controls" style="justify-content:flex-start;">
        <label class="small note">If the Excel file is not on the server you can upload it here:</label>
        <input id="file-input" type="file" accept=".xlsx,.xls,.csv" class="small" />
      </div>
      <div class="controls" style="justify-content:flex-end;">
        <button id="zoom-all" class="btn">Zoom to All</button>
        <button id="toggle-route" class="btn">Toggle Route</button>
      </div>
    </div>

    <p class="note" id="status">Loading itinerary (attempting to read ShowcasingOz TV Business.xlsx)...</p>

    <h2>Planned Filming Schedule (one entry per town, date order)</h2>
    <table id="itinerary-table" aria-describedby="status">
      <thead>
        <tr><th>Date Range</th><th>Town</th><th>Attractions / Filming Highlights</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <p class="note" style="margin-top:8px;">Data source: <strong>Itinerary 2026</strong> sheet from your uploaded Excel file.</p>
  </div>

  <!-- FOOTER (copied from your index.html) -->
  <footer>
    <div class="footer-links">
      <a href="index.html">Home</a> |
      <a href="about.html">About Us</a> |
      <a href="partner.html">Partner With Us</a> |
      <a href="sponsorship.html">Sponsorship</a> |
      <a href="contact.html">Contact</a> |
      <a href="filmingmap.html">Filming Map</a>
    </div>

    <p>
      ðŸ“§ <a href="mailto:showcasingoztv@gmail.com">showcasingoztv@gmail.com</a><br>
      Â© 2025 ShowcasingOz TV Â· Discover. Capture. Share.
    </p>
  </footer>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- SheetJS for reading .xlsx client-side -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
  // Utility: escape HTML
  function escapeHtml(s) { if(!s) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }

  // Initialize map
  const map = L.map('map').setView([-25.0, 134.0], 4);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 18, attribution: '&copy; OpenStreetMap contributors'}).addTo(map);

  const tableBody = document.querySelector('#itinerary-table tbody');
  const statusEl = document.getElementById('status');
  const zoomAllBtn = document.getElementById('zoom-all');
  const toggleRouteBtn = document.getElementById('toggle-route');
  const fileInput = document.getElementById('file-input');

  let markersLayer = L.layerGroup().addTo(map);
  let routeLayer = L.layerGroup().addTo(map);
  let routePolyline = null;
  let bounds = L.latLngBounds();

  // Read file from server (attempt), fallback to user upload
  async function tryLoadServerFile() {
    const serverPath = './ShowcasingOz TV Business.xlsx';
    try {
      const resp = await fetch(serverPath);
      if (!resp.ok) throw new Error('not found');
      const ab = await resp.arrayBuffer();
      return await parseWorkbook(ab);
    } catch (e) {
      return null;
    }
  }

  // Parse an ArrayBuffer workbook to records (unique towns, date order)
  async function parseWorkbook(arrayBuffer) {
    try {
      const wb = XLSX.read(arrayBuffer, {type: 'array'});
      // try to use sheet named "Itinerary 2026" first, otherwise first sheet
      const sheetName = wb.SheetNames.find(n => n.toLowerCase().includes('itiner')) || wb.SheetNames[0];
      const sheet = wb.Sheets[sheetName];
      const rows = XLSX.utils.sheet_to_json(sheet, {defval: ''}); // array of objects keyed by header
      // Expect headers like: Date, Town, Activities & Attractions (case-insensitive)
      // Normalize keys to find right columns
      if (!rows || rows.length === 0) return [];

      // Determine header keys
      const hdrs = Object.keys(rows[0]).map(h => ({orig:h, key: String(h).trim()}));
      function findKey(possibles) {
        for (const p of possibles) {
          const found = hdrs.find(h => h.key.toLowerCase().includes(p.toLowerCase()));
          if (found) return found.orig;
        }
        return null;
      }
      const dateKey = findKey(['date','day']);
      const townKey = findKey(['town','city']);
      const attrKey = findKey(['activity','attraction','itiner','attract','activities']);

      // Fallback to positions if not found
      const sampleRow = rows[0];
      const keys = Object.keys(sampleRow);
      const dk = dateKey || keys[0];
      const tk = townKey || keys[1] || keys[0];
      const ak = attrKey || keys[2] || keys[keys.length-1];

      // Build intermediate array with DateStr, Town, Attractions
      const list = rows.map(r => {
        let dateRaw = r[dk];
        let dateStr = '';
        if (dateRaw && typeof dateRaw === 'object' && dateRaw instanceof Date) dateStr = dateRaw.toISOString().split('T')[0];
        else if (dateRaw) {
          // try parse
          const d = new Date(dateRaw);
          if (!isNaN(d)) dateStr = d.toISOString().split('T')[0];
          else dateStr = String(dateRaw).trim();
        }
        const town = String(r[tk] || '').trim();
        const attractions = String(r[ak] || '').trim();
        return {DATE: dateStr, TOWN: town, ATTRACTIONS: attractions};
      });

      // Filter out empty towns
      const filtered = list.filter(r => r.TOWN && r.TOWN !== '');

      // Exclude Annual Leave / RDO / Public Holiday in ATTRACTIONS (case-insensitive)
      const filtered2 = filtered.filter(r => {
        const s = (r.ATTRACTIONS || '').toLowerCase();
        return !(s.includes('annual leave') || s.includes('rdo') || s.includes('public holiday'));
      });

      // Aggregate unique towns: collect dates, attractions, earliest date
      const agg = {};
      for (const row of filtered2) {
        const town = row.TOWN;
        const date = row.DATE || '';
        let attr = row.ATTRACTIONS || '';
        if (!agg[town]) agg[town] = {dates: new Set(), attractions: new Set()};
        if (date) agg[town].dates.add(date);
        if (attr && attr !== 'nan') {
          // split by lines or slashes/semicolons
          let parts = attr.split(/\r?\n/).map(x => x.trim()).filter(Boolean);
          if (parts.length === 1) {
            parts = attr.split(/\/|;|\|/).map(x => x.trim()).filter(Boolean);
          }
          for (const p of parts) if (p) agg[town].attractions.add(p);
        }
      }

      // Build records list and sort by earliest date
      const recs = [];
      for (const [town, v] of Object.entries(agg)) {
        const dates = Array.from(v.dates).filter(Boolean).sort();
        let dateRange = '';
        let firstDate = '';
        if (dates.length === 1) { dateRange = dates[0]; firstDate = dates[0]; }
        else if (dates.length > 1) { dateRange = dates[0] + ' â†’ ' + dates[dates.length-1]; firstDate = dates[0]; }
        const attractions = Array.from(v.attractions).join(' / ');
        recs.push({DATE_RANGE: dateRange, FIRST_DATE: firstDate, TOWN: town, ATTRACTIONS: attractions});
      }
      // sort by FIRST_DATE (empty dates go last)
      recs.sort((a,b) => {
        if (!a.FIRST_DATE && !b.FIRST_DATE) return a.TOWN.localeCompare(b.TOWN);
        if (!a.FIRST_DATE) return 1;
        if (!b.FIRST_DATE) return -1;
        return a.FIRST_DATE.localeCompare(b.FIRST_DATE);
      });

      return recs;
    } catch (err) {
      console.error('parseWorkbook error', err);
      return [];
    }
  }

  // Attempt to auto-load the Excel file from the server root (same folder)
  async function loadAndRender() {
    statusEl.textContent = 'Attempting to load server-side Excel...';
    let recs = await tryLoadServerFile();
    if (!recs || recs.length === 0) {
      statusEl.textContent = 'Server file not found â€” waiting for upload or choose file.';
      return;
    }
    // If recs exists (from server fetch), but tryLoadServerFile returned parsed workbook object,
    // our tryLoadServerFile returns parseWorkbook result (array). So use that.
    await renderFromRecords(recs);
  }

  // Render function: given records array, geocode + place markers + draw route + fill table
  async function renderFromRecords(records) {
    // clear previous
    markersLayer.clearLayers();
    routeLayer.clearLayers();
    tableBody.innerHTML = '';
    bounds = L.latLngBounds();
    let remaining = records.length;
    statusEl.textContent = `Geocoding ${remaining} towns â€” please wait...`;
    const routeCoords = [];

    for (const r of records) {
      // append row to table
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${escapeHtml(r.DATE_RANGE)}</td><td>${escapeHtml(r.TOWN)}</td><td>${escapeHtml(r.ATTRACTIONS)}</td>`;
      tableBody.appendChild(tr);

      // geocode
      const coords = await geocodeTown(r.TOWN);
      if (coords) {
        const marker = L.marker([coords.lat, coords.lon]).addTo(markersLayer);
        marker.bindPopup(`<div class="popup-content"><strong>${escapeHtml(r.TOWN)}</strong><br/><em>${escapeHtml(r.DATE_RANGE)}</em><p>${escapeHtml(r.ATTRACTIONS)}</p></div>`);
        bounds.extend([coords.lat, coords.lon]);
        routeCoords.push([coords.lat, coords.lon]);
      } else {
        // fallback: grey point at center
        const fallback = L.circleMarker([-25.0, 134.0], {radius:6, color:'#666'}).addTo(markersLayer);
        fallback.bindPopup(`<strong>${escapeHtml(r.TOWN)}</strong><br/><em>Geocoding not found</em><p>${escapeHtml(r.ATTRACTIONS)}</p>`);
        routeCoords.push([-25.0, 134.0]);
      }

      remaining -= 1;
      statusEl.textContent = remaining > 0 ? `Geocoding... (${remaining} remaining)` : 'All towns processed.';
      // polite delay to minimize Nominatim throttling
      await new Promise(res => setTimeout(res, 400));
    }

    // Draw route (polyline)
    if (routeCoords.length > 1) {
      routePolyline = L.polyline(routeCoords, {color: '#E87722', weight: 4, opacity: 0.9}).addTo(routeLayer);
    }

    if (bounds.isValid()) map.fitBounds(bounds.pad(0.2));
    else map.setView([-25.0,134.0], 4);
  }

  // Geocode using Nominatim (OpenStreetMap)
  async function geocodeTown(town) {
    if (!town) return null;
    const q = encodeURIComponent(town + ', Australia');
    const url = `https://nominatim.openstreetmap.org/search?q=${q}&format=json&limit=1`;
    try {
      const resp = await fetch(url, { headers: { 'Accept-Language': 'en' }});
      const data = await resp.json();
      if (data && data.length > 0) return {lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon)};
      return null;
    } catch (e) {
      return null;
    }
  }

  // Fallback: parse user-uploaded file
  fileInput.addEventListener('change', async (ev) => {
    const f = ev.target.files[0];
    if (!f) return;
    statusEl.textContent = 'Parsing uploaded file â€” please wait...';
    try {
      const ab = await f.arrayBuffer();
      const recs = await parseWorkbook(ab);
      if (!recs || recs.length === 0) {
        statusEl.textContent = 'No usable rows found in the uploaded file. Check headers and sheet name.';
        return;
      }
      await renderFromRecords(recs);
    } catch (err) {
      console.error(err);
      statusEl.textContent = 'Error parsing uploaded file.';
    }
  });

  // Try to auto-load server file first. If not present, user can upload
  (async () => {
    const recs = await tryLoadServerFile();
    if (recs && recs.length) {
      await renderFromRecords(recs);
    } else {
      statusEl.textContent = 'No server-side Excel found â€” please use the Upload control to load your itinerary, or place "ShowcasingOz TV Business.xlsx" in the same folder as this page.';
    }
  })();

  // Buttons
  zoomAllBtn.addEventListener('click', () => { if (bounds.isValid()) map.fitBounds(bounds.pad(0.2)); });
  toggleRouteBtn.addEventListener('click', () => {
    if (!routePolyline) return;
    if (map.hasLayer(routePolyline)) map.removeLayer(routePolyline);
    else routePolyline.addTo(map);
  });
  </script>

</body>
</html>
