<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ShowcasingOz TV Filming Map</title>

  <!-- Font Awesome for social icons -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer" />

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    body { font-family: "Segoe UI", Roboto, Arial, sans-serif; margin: 0; color: #0E3557; background: #fff; }
    header.navbar { background: #0E3557; color: #fff; padding: 15px 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
    header.navbar .container { display: flex; justify-content: space-between; align-items: center; max-width: 1100px; margin: 0 auto; padding: 0 20px; }
    header.navbar img { height: 50px; width: auto; }
    nav a { color: #fff; margin-left: 20px; text-decoration: none; font-weight: 500; }
    nav a:hover { color: #E87722; transition: color 0.3s ease; }
    .menu-btn { display: none; font-size: 1.5rem; cursor: pointer; }
    @media (max-width: 768px) { nav { display: none; flex-direction: column; background: #0E3557; position: absolute; top: 70px; right: 0; width: 100%; } nav.active { display: flex; } .menu-btn { display: block; } nav a { padding: 15px; border-top: 1px solid rgba(255,255,255,0.1); } }
    .banner { display: block; width: 100%; height: 260px; background: url('banner.png') center top / contain no-repeat; background-color: #ffffff; border: none; margin-bottom: 20px; }
    .hero { padding: 18px; background: linear-gradient(180deg,#0f172a,#0b1220); color: white; text-align:center; }
    #map { height: 60vh; min-height: 480px; }
    .container { padding: 18px; max-width: 1100px; margin: 0 auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: top; }
    th { background: #f4f4f4; }
    .note { font-size:0.95rem; color:#444; }
    .popup-content { max-width: 320px; }
    .controls { display:flex; gap:12px; align-items:center; margin-top:12px; justify-content:flex-end; }
    .btn { background:#0b74de; color:white; padding:8px 12px; border-radius:6px; border:none; cursor:pointer }
    footer { background: #0E3557; color: #fff; padding: 30px 20px; font-size: 0.9rem; margin-top: 50px; }
    footer .footer-links { margin-bottom: 15px; }
    footer a { color: #E87722; text-decoration: none; margin: 0 10px; }
    footer a:hover { text-decoration: underline; }
    @media (max-width: 900px) { .container { padding: 12px; } }
  </style>
</head>
<body>

  <!-- HEADER / NAVBAR (copied from index.html) -->
  <header class="navbar">
    <div class="container">
      <a href="index.html">
        <img src="logo.png" alt="ShowcasingOz TV Logo">
      </a>
      <span class="menu-btn" id="menu-btn"><i class="fa fa-bars"></i></span>
      <nav id="menu">
        <a href="index.html">Home</a>
        <a href="about.html">About Us</a>
        <a href="partner.html">Partner With Us</a>
        <a href="sponsorship.html">Sponsorship</a>
        <a href="contact.html">Contact</a>
        <a href="filmingmap.html">Filming Map</a>
      </nav>
    </div>
  </header>

  <script>
    // Mobile menu toggle
    const menuBtn = document.getElementById('menu-btn');
    const menu = document.getElementById('menu');
    if (menuBtn) menuBtn.addEventListener('click', () => menu.classList.toggle('active'));
  </script>

  <!-- Banner -->
  <section class="banner"></section>

  <div class="hero">
    <h1>ShowcasingOz TV Filming Map</h1>
    <p>Interactive map showing each town we will visit (one marker per town). Click pins for dates and attractions. Route line connects towns in visit order.</p>
  </div>

  <!-- Map -->
  <div id="map"></div>

  <div class="container">
    <!-- Removed upload note / file input and removed Zoom/Toggle buttons per request -->
    <p class="note" id="status">Loading itinerary data and placing markers...</p>

    <h2>Planned Filming Schedule (one entry per town, date order)</h2>
    <table id="itinerary-table" aria-describedby="status">
      <thead>
        <tr><th>Date Range</th><th>Town</th><th>Attractions / Filming Highlights</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <p class="note" style="margin-top:8px;">Data source: <strong>Itinerary 2026</strong> sheet from your uploaded Excel file.</p>
  </div>

  <!-- FOOTER (copied from index.html) -->
  <footer>
    <div class="footer-links">
      <a href="index.html">Home</a> |
      <a href="about.html">About Us</a> |
      <a href="partner.html">Partner With Us</a> |
      <a href="sponsorship.html">Sponsorship</a> |
      <a href="contact.html">Contact</a> |
      <a href="filmingmap.html">Filming Map</a>
    </div>

    <p>
      ðŸ“§ <a href="mailto:showcasingoztv@gmail.com">showcasingoztv@gmail.com</a><br>
      Â© 2025 ShowcasingOz TV Â· Discover. Capture. Share.
    </p>
  </footer>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- SheetJS for reading .xlsx client-side (kept in case you want server fallback parsing; file input UI removed) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
  // Helper: escape HTML
  function escapeHtml(s) { if(!s) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }

  // Manual geocode overrides to force correct state for ambiguous towns
  const geocodeOverrides = {
    "Hopetoun": "Hopetoun, VIC, Australia",
    "Rabbit Flat": "Rabbit Flat, Northern Territory, Australia",
    "Laura": "Laura, SA, Australia",
    "Ivanhoe": "Ivanhoe, NSW, Australia"
  };

  // Initialize Leaflet map
  const map = L.map('map').setView([-25.0, 134.0], 4);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18, attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

  const tableBody = document.querySelector('#itinerary-table tbody');
  const statusEl = document.getElementById('status');

  let markersLayer = L.layerGroup().addTo(map);
  let routeLayer = L.layerGroup().addTo(map);
  let routePolyline = null;
  let bounds = L.latLngBounds();

  // Attempt to auto-load spreadsheet from same folder on server
  async function tryLoadServerFile() {
    const serverPath = './ShowcasingOz TV Business.xlsx';
    try {
      const resp = await fetch(serverPath);
      if (!resp.ok) throw new Error('not found');
      const ab = await resp.arrayBuffer();
      return await parseWorkbook(ab);
    } catch (e) {
      return null;
    }
  }

  // Parse an ArrayBuffer workbook into records (unique towns, date order)
  async function parseWorkbook(arrayBuffer) {
    try {
      const wb = XLSX.read(arrayBuffer, {type:'array', cellDates:true});
      const sheetName = wb.SheetNames.find(n => n.toLowerCase().includes('itiner')) || wb.SheetNames[0];
      const ws = wb.Sheets[sheetName];
      const rows = XLSX.utils.sheet_to_json(ws, {defval: ''});
      if (!rows || rows.length === 0) return [];

      // determine column keys
      const keys = Object.keys(rows[0]);
      function findKey(cands) {
        for (const c of cands) {
          for (const k of keys) {
            if (String(k).trim().toLowerCase().includes(c)) return k;
          }
        }
        return null;
      }
      const dateKey = findKey(['date','day']);
      const townKey = findKey(['town','city']);
      const attrKey = findKey(['activity','attraction','attractions','itiner']);

      const dk = dateKey || keys[0];
      const tk = townKey || keys[1] || keys[0];
      const ak = attrKey || keys[2] || keys[keys.length-1];

      // map rows to normalized structure
      const normalized = rows.map(r => {
        const rawDate = r[dk];
        let dateObj = null;
        if (rawDate instanceof Date) dateObj = rawDate;
        else if (typeof rawDate === 'number') {
          // Excel serial to JS date
          const ms = (rawDate - 25569) * 86400 * 1000;
          const d = new Date(ms);
          if (!isNaN(d)) dateObj = d;
        } else if (rawDate !== null && rawDate !== '') {
          const parsed = new Date(String(rawDate));
          if (!isNaN(parsed)) dateObj = parsed;
        }
        const dateStr = dateObj ? String(String(dateObj.getDate()).padStart(2,'0') + '/' + String(dateObj.getMonth()+1).padStart(2,'0') + '/' + dateObj.getFullYear()) : '';
        const town = (r[tk] !== undefined && r[tk] !== null) ? String(r[tk]).trim() : '';
        const attractions = (r[ak] !== undefined && r[ak] !== null) ? String(r[ak]).trim() : '';
        return { DATE_OBJ: dateObj, DATE_STR: dateStr, TOWN: town, ATTRACTIONS: attractions };
      });

      // filter out blank towns and exclude Annual Leave / RDO / Public Holiday
      const filtered = normalized.filter(r => r.TOWN && r.TOWN !== '' && !(String(r.ATTRACTIONS || '').toLowerCase().includes('annual leave') || String(r.ATTRACTIONS || '').toLowerCase().includes('rdo') || String(r.ATTRACTIONS || '').toLowerCase().includes('public holiday')));

      // aggregate by town
      const agg = {};
      for (const row of filtered) {
        const town = row.TOWN;
        if (!agg[town]) agg[town] = { dates: new Set(), attractions: new Set(), firstDateObj: null };
        if (row.DATE_STR) agg[town].dates.add(row.DATE_STR);
        if (row.DATE_OBJ && (!agg[town].firstDateObj || row.DATE_OBJ < agg[town].firstDateObj)) agg[town].firstDateObj = row.DATE_OBJ;
        if (row.ATTRACTIONS && row.ATTRACTIONS.toString().toLowerCase() !== 'nan') {
          let parts = row.ATTRACTIONS.split(/\r?\n/).map(x => x.trim()).filter(Boolean);
          if (parts.length === 0) parts = row.ATTRACTIONS.split(/\/|;|\|/).map(x => x.trim()).filter(Boolean);
          if (parts.length === 0) parts = [row.ATTRACTIONS.trim()];
          for (const p of parts) agg[town].attractions.add(p);
        }
      }

      // build records array
      const records = [];
      for (const [town, v] of Object.entries(agg)) {
        const dates = Array.from(v.dates).filter(Boolean).sort((a,b) => {
          try {
            const ad = a.split('/'); const bd = b.split('/');
            const ado = new Date(+ad[2], +ad[1]-1, +ad[0]);
            const bdo = new Date(+bd[2], +bd[1]-1, +bd[0]);
            return ado - bdo;
          } catch(e) { return 0; }
        });
        let dateRange = '';
        if (dates.length === 1) dateRange = dates[0];
        else if (dates.length > 1) dateRange = dates[0] + ' â†’ ' + dates[dates.length-1];
        const firstDate = v.firstDateObj ? (String(String(v.firstDateObj.getDate()).padStart(2,'0') + '/' + String(v.firstDateObj.getMonth()+1).padStart(2,'0') + '/' + v.firstDateObj.getFullYear())) : '';
        const attractions = Array.from(v.attractions).join(' / ');
        const geocodeQuery = geocodeOverrides[town] ? geocodeOverrides[town] : (town + ', Australia');
        records.push({ DATE_RANGE: dateRange, FIRST_DATE: firstDate, TOWN: town, ATTRACTIONS: attractions, GEOCODE_QUERY: geocodeQuery });
      }

      // sort by FIRST_DATE (empty last)
      records.sort((a,b) => {
        if (!a.FIRST_DATE && !b.FIRST_DATE) return a.TOWN.localeCompare(b.TOWN);
        if (!a.FIRST_DATE) return 1;
        if (!b.FIRST_DATE) return -1;
        const ad = a.FIRST_DATE.split('/'), bd = b.FIRST_DATE.split('/');
        const ao = new Date(+ad[2], +ad[1]-1, +ad[0]);
        const bo = new Date(+bd[2], +bd[1]-1, +bd[0]);
        return ao - bo;
      });

      return records;

    } catch (err) {
      console.error('parseWorkbook error', err);
      return [];
    }
  }

  // geocode helper using Nominatim, queries use GEOCODE_QUERY if provided
  async function geocodeQuery(query) {
    if (!query) return null;
    const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1`;
    try {
      const resp = await fetch(url, { headers: { 'Accept-Language': 'en' }});
      const data = await resp.json();
      if (data && data.length > 0) return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
      return null;
    } catch (e) {
      console.error('geocode error', e);
      return null;
    }
  }

  // Render records: place markers, popups, table, route
  async function renderFromRecords(records) {
    markersLayer.clearLayers();
    routeLayer.clearLayers();
    tableBody.innerHTML = '';
    bounds = L.latLngBounds();
    const routeCoords = [];
    let remaining = records.length;
    statusEl.textContent = `Geocoding ${remaining} towns â€” please wait...`;

    for (const r of records) {
      // add table row
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${escapeHtml(r.DATE_RANGE)}</td><td>${escapeHtml(r.TOWN)}</td><td>${escapeHtml(r.ATTRACTIONS)}</td>`;
      tableBody.appendChild(tr);

      // geocode with GEOCODE_QUERY override
      const q = r.GEOCODE_QUERY || (r.TOWN + ', Australia');
      const coords = await geocodeQuery(q);
      if (coords) {
        const marker = L.marker([coords.lat, coords.lon]).addTo(markersLayer);
        marker.bindPopup(`<div class="popup-content"><strong>${escapeHtml(r.TOWN)}</strong><br/><em>${escapeHtml(r.DATE_RANGE)}</em><p>${escapeHtml(r.ATTRACTIONS)}</p></div>`);
        bounds.extend([coords.lat, coords.lon]);
        routeCoords.push([coords.lat, coords.lon]);
      } else {
        const fallback = L.circleMarker([-25.0, 134.0], { radius:6, color:'#666' }).addTo(markersLayer);
        fallback.bindPopup(`<strong>${escapeHtml(r.TOWN)}</strong><br/><em>Geocoding not found</em><p>${escapeHtml(r.ATTRACTIONS)}</p>`);
        routeCoords.push([-25.0, 134.0]);
      }

      remaining -= 1;
      statusEl.textContent = remaining > 0 ? `Geocoding... (${remaining} remaining)` : 'All towns processed.';
      // polite delay to avoid Nominatim rate limits
      await new Promise(res => setTimeout(res, 400));
    }

    if (routeCoords.length > 1) {
      routePolyline = L.polyline(routeCoords, { color: '#E87722', weight: 4, opacity: 0.9 }).addTo(routeLayer);
    }
    if (bounds.isValid()) map.fitBounds(bounds.pad(0.2));
    else map.setView([-25.0,134.0], 4);
  }

  // Try to load server file and render; if not present, instruct user to place file on server
  (async () => {
    statusEl.textContent = 'Attempting to load itinerary from server file...';
    const serverRecs = await tryLoadServerFile();
    if (serverRecs && serverRecs.length) {
      await renderFromRecords(serverRecs);
    } else {
      statusEl.textContent = 'Server-side Excel not found â€” please place "ShowcasingOz TV Business.xlsx" in the same folder as this page and reload.';
    }
  })();

  </script>

</body>
</html>




